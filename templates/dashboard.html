{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="fw-bold">Dashboard</h2>
        <p class="text-muted mb-0">Your training at a glance.</p>
    </div>
    <div>
        <a class="btn btn-primary" href="{% url 'problem_create' %}">Add Problem</a>
        <a class="btn btn-outline-primary" href="{% url 'review_queue' %}">Reviews ({{ nav_due_reviews }})</a>
    </div>
</div>
<div class="row g-4">
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-muted">Today's reviews</h6>
                <h3 class="fw-bold">{{ due_reviews.count }}</h3>
                {% if due_reviews %}
                    <ul class="list-group list-group-flush">
                        {% for item in due_reviews|slice:":5" %}
                        <li class="list-group-item">{{ item.prompt|truncatewords:10 }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted mb-0">You're clear for today.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-muted">Attempts</h6>
                <h3 class="fw-bold">{{ attempts_last7 }} <span class="text-muted fs-6">last 7 days</span></h3>
                <p class="mb-0 text-muted">{{ attempts_last30 }} last 30 days total</p>
                <div class="mt-3">
                    <h6 class="text-uppercase text-muted">Recent</h6>
                    <ul class="list-group list-group-flush">
                        {% for a in recent_attempts %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ a.problem.title }}</strong><br>
                                <small class="text-muted">{{ a.get_outcome_display }} â€¢ {{ a.started_at|date:"M d" }}</small>
                            </div>
                            <span class="badge bg-secondary">{{ a.duration_display }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted">No attempts yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h6 class="text-uppercase text-muted">Top mistake types</h6>
                <ul class="list-group list-group-flush">
                    {% for m in top_mistakes %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ m.mistake_type__name }}</span>
                        <span class="badge bg-danger">{{ m.total }}</span>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-muted">No mistakes logged yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="card mt-4 shadow-sm">
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title mb-0">Topic balance</h5>
                <p class="text-muted mb-0">Keep a healthy spread across NT/Alg/Geo/Comb.</p>
            </div>
        </div>
        <canvas id="topicChart" height="120"></canvas>
    </div>
</div>
<script>
const ctx = document.getElementById('topicChart');
if (ctx) {
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ topic_labels|safe }},
            datasets: [{
                label: 'Attempts',
                data: {{ topic_data|safe }},
                backgroundColor: ['#0d6efd', '#6f42c1', '#20c997', '#fd7e14', '#adb5bd'],
            }]
        },
        options: {plugins: {legend: {position: 'bottom'}}}
    });
}
</script>
{% endblock %}
